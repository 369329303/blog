---
layout: post
title: 如何优化nginx的配置
---

## 如何优化nginx的配置

### Linux系统参数设置
1. **积压队列**

   `net.core.somaxconn`:  
   积压队列中的最大连接数。如果这个值的大于512，那么在nginx配置文件中也要修改listen指令中的backlog参数。  

2. **文件描述符**

   `fs.file-max`:  
   系统级文件描述符限制

   `nofile`:  
   用户级文件描述符限制

3. **剩余端口**

   `net.ipv4_ip_local_port_range`:  
   当连接数目很大时，通常设置为1024-65000  

### nginx参数设置
1. **worker 进程**

   `worker_processes`:  
   推荐设置成auto,由程序自己来推断应该孵化多少个worker

   `worker_connections`:  
   每个worker能够同时处理的最大连接数

2. **Keepalive 连接**

   `keepalive_requests`:  
   一个keepalive连接上，客户端可以发起的请求数

   `keepalive_timeout`:  
   keepalive连接可以处于空闲状态的最大时间

   `keepalive`:  
   每个worker与上游服务器之间拥有的最大空闲keepalive连接数目。没有默认值。  
   需要配合proxy_http_version 1.1; 和 proxy_set_header Connection ""; 一起使用。

3. **访问日志**

   `access_log`:  
   是否启用访问日志，如果启用还需指定buffer和flush参数。

4. **sendfile**

   `sendfile`:  
   开启sendfile可以提高tcp数据传输速度。  
   当开启gzip的时候，nginx会自动禁止sendfile选项。  

### 缓存
不适合证券行情接口，不做优化

### 压缩
开启后，效果不明显。就默认关闭了。并且传输内容的最大也就300kb左右。

### 配置文件
/etc/sysctl.conf 配置文件
```ini
net.core.somaxconn = 10000
net.ipv4.ip_local_port_range = 1000 65535
fs.file-max = 100000
```

nginx.conf 配置文件
```nginx
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;

events {
   worker_connections 4096;
}

http {
   include       mime.types;
   default_type  application/octet-stream;

   sendfile       on;

   keepalive_requests 1000;

   access_log off;

   upstream upCluster{
      keepalive 100;
      server 192.168.0.225:8124;
   }

   server {
      listen      9188 backlog=10000;
      location / {
         proxy_pass http://upCluster;
         proxy_http_version 1.1;
         proxy_set_header Connection "";
      }   
   }      

   server {  
      listen      80 backlog=10000;
      location / {
         root /var/www/html;
      }   
   } 
}   
```

---

#### 参考文档
1. [Tuning NGINX for Performance](https://www.nginx.com/blog/tuning-nginx/)